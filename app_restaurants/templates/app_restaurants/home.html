{% extends 'base.html' %}

{% block title %}ç±³å…¶æ—é¤å»³åˆ—è¡¨{% endblock %}

{% block extra_css %}
<style>
  body {
    background-color: #f5f3ef;
    color: #1C1C1C;
    font-family: 'Segoe UI', 'Noto Sans TC', sans-serif;
  }

  .container-flex {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
  }

  .left-panel {
    width: 300px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .left-panel > .card {
    flex-grow: 1;
  }

  .chart-card {
    flex-grow: 1;
    min-height: 320px;
  }

  /* å¡ç‰‡é¢¨æ ¼ */
  .card {
    border-radius: 12px;
    border: none;
    background-color: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }

  /* å¡ç‰‡æ¨™é¡Œ */
  .card-header {
    font-weight: 600;
    font-size: 1rem;
  }

  .card-header.bg-primary {
    background-color: #3e3e3e !important;
    color: #fff;
  }

  .card-header.bg-info {
    background-color: #3e3e3e !important;
    color: #fff;
  }

  .card-header.bg-success {
    background-color: #C9A86B !important;
    color: #fff;
  }

  .custom-chart-header {
    background-color: #C9A86B;
  }

  /* ç¯©é¸æŒ‰éˆ• */
  #cityButtons button, #cuisineButtons button {
    min-width: 80px;
    margin-bottom: 6px;
    font-weight: 500;
  }

  #cityButtons button,
  #cuisineButtons button {
    width: 100%;
    text-align: center;
  }

  #cityButtons .btn-primary,
#cuisineButtons .btn-primary {
  background-color: #C9A86B !important;
  border-color: #C9A86B !important;
  color: #fff !important;
}

#cityButtons .btn-outline-primary,
#cuisineButtons .btn-outline-info {
  background-color: #fff !important;
  border: 1px solid #C9A86B !important;
  color: #C9A86B !important;
}

#cityButtons .btn-outline-primary:hover,
#cuisineButtons .btn-outline-info:hover {
  background-color: #C9A86B !important;
  color: #fff !important;
}


  /* é¤å»³åˆ—è¡¨ */
  #restaurantList .list-group-item {
    border-radius: 8px;
    margin-bottom: 6px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    background-color: #fff;
    border: none;
  }

  #restaurantList a {
    color: #C9A86B;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
  }

  #restaurantList a:hover {
    color: #A6813C;
  }

  #restaurantList h5.mb-1 {
    font-size: 1.6rem;
    line-height: 1.6;
    color: #1C1C1C;
  }

  /* åˆ†é æŒ‰éˆ• */
  .pagination .page-item.active .page-link {
    background-color: #C9A86B;
    border-color: #C9A86B;
    color: white;
  }

  .pagination .page-link {
    color: #C9A86B;
    border-radius: 6px;
    border: 1px solid #C9A86B;
    background-color: #fff;
  }

  .pagination .page-link:hover {
    background-color: #A6813C;
    color: white;
    border-color: #A6813C;
  }

  /* æœå°‹è¼¸å…¥æ¡† */
  #cuisineSearch {
    border: 1px solid #C9A86B;
    border-radius: 6px;
  }

  #cuisineSearch:focus {
    box-shadow: 0 0 0 0.2rem rgba(201, 168, 107, 0.25);
    border-color: #A6813C;
  }

</style>
{% endblock %}

{% block content %}
  <div class="col-lg-12">
    <h1>ç±³å…¶æ—é¤å»³</h1>
    <p>æ¢ç´¢ã€Šç±³å…¶æ—æŒ‡å—ã€‹ç²¾é¸çš„é¤å»³</p>
  </div>
<div class="container-flex">
  <div class="left-panel">
    <!-- ç¯©é¸åŸå¸‚ -->
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h3 class="h6 text-uppercase mb-0">ç¯©é¸åŸå¸‚</h3>
      </div>
      <div class="card-body" id="cityButtons">
        <button type="button" class="btn btn-primary active" data-city="all">å…¨éƒ¨åŸå¸‚</button>
        <button type="button" class="btn btn-outline-primary" data-city="Taipei">Taipei</button>
        <button type="button" class="btn btn-outline-primary" data-city="Taichung">Taichung</button>
        <button type="button" class="btn btn-outline-primary" data-city="Tainan">Tainan</button>
        <button type="button" class="btn btn-outline-primary" data-city="Kaohsiung">Kaohsiung</button>
      </div>
    </div>

    <!-- ç¯©é¸èœç³» -->
    <div class="card shadow-sm">
      <div class="card-header bg-info text-white">
        <h3 class="h6 text-uppercase mb-0">ç¯©é¸èœç³»</h3>
      </div>
      <input type="text" id="cuisineSearch" class="form-control mb-3" placeholder="è¼¸å…¥èœç³»åç¨±æœå°‹â€¦">
      <div class="card-body" id="cuisineButtons">
        <button type="button" class="btn btn-primary active" data-cuisine="all">å…¨éƒ¨èœç³»</button>
        <button type="button" class="btn btn-outline-info" data-cuisine="ç²µèœ">ç²µèœ</button>
        <button type="button" class="btn btn-outline-info" data-cuisine="è‡ºç£èœ">è‡ºç£èœ</button>
        <button type="button" class="btn btn-outline-info" data-cuisine="å°åƒ">å°åƒ</button>
        <button type="button" class="btn btn-outline-info" data-cuisine="å‰µæ–°èœ">å‰µæ–°èœ</button>
        <button type="button" class="btn btn-outline-info" data-cuisine="éºµé£Ÿ">éºµé£Ÿ</button>
      </div>
    </div>
    
  </div>

  
  

  <!-- å³å´åœ–è¡¨ -->
  <div class="card shadow-sm chart-card">
    <div class="card-header custom-chart-header text-white">
      <h3 class="h6 text-uppercase mb-0">èœç³»åˆ†æï¼ˆä¾åŸå¸‚ï¼‰</h3>
    </div>
    <div class="card-body">
      <canvas id="cuisineChart" style="height: 300px;"></canvas>
    </div>
    
  </div>
</div>



<!-- é¤å»³åˆ—è¡¨ -->
<div class="card shadow-sm">
  <div class="card-header bg-success text-white">
    <h3 class="h6 text-uppercase mb-0">é¤å»³æ¸…å–®</h3>
  </div>
  <div class="card-body">
    <ul class="list-group list-group-flush" id="restaurantList" style="min-height: 300px;">
      <!-- AJAX è¼‰å…¥ -->
    </ul>
    <nav aria-label="Page navigation" class="mt-3">
      <ul class="pagination justify-content-center" id="pagination" style="display:none;"></ul>
    </nav>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(function () {
  let allRestaurants = [];
  const pageSize = 20;
  let currentPage = 1;
  let selectedCities = ['all'];
  let selectedCuisines = ['all'];
  let chart;
  let isSearching = false;

  // åˆ†é æ¸²æŸ“ï¼ˆfor æ­£å¸¸æƒ…æ³ï¼‰
  function renderPagination() {
  const totalPages = Math.ceil(allRestaurants.length / pageSize);
  const pagination = $('#pagination');
  pagination.empty();
  if (totalPages <= 1) {
    pagination.hide();
    return;
  }
  pagination.show();

  const prevDisabled = (currentPage === 1) ? 'disabled' : '';
  pagination.append(`<li class="page-item ${prevDisabled}"><a class="page-link" href="#" id="prevPage">ä¸Šä¸€é </a></li>`);

  // ç¬¬ä¸€é 
  pagination.append(`<li class="page-item ${currentPage === 1 ? 'active' : ''}"><a class="page-link" href="#">1</a></li>`);

  // æ˜¯å¦é¡¯ç¤ºç¬¬ä¸€å€‹çœç•¥è™Ÿ
  if (currentPage - 3 > 1) {
    pagination.append(`<li class="page-item disabled"><a class="page-link" href="#">...</a></li>`);
  }

  // é¡¯ç¤ºç•¶å‰é å‰å¾Œå…©é 
  let startPage = Math.max(2, currentPage - 2);
  let endPage = Math.min(totalPages - 1, currentPage + 2);

  for (let i = startPage; i <= endPage; i++) {
    pagination.append(`<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#">${i}</a></li>`);
  }

  // æ˜¯å¦é¡¯ç¤ºæœ€å¾Œä¸€å€‹çœç•¥è™Ÿ
  if (currentPage + 2 < totalPages - 1) {
    pagination.append(`<li class="page-item disabled"><a class="page-link" href="#">...</a></li>`);
  }

  // æœ€å¾Œä¸€é ï¼ˆå¤§æ–¼1æ‰é¡¯ç¤ºï¼‰
  if (totalPages > 1) {
    pagination.append(`<li class="page-item ${currentPage === totalPages ? 'active' : ''}"><a class="page-link" href="#">${totalPages}</a></li>`);
  }

  const nextDisabled = (currentPage === totalPages) ? 'disabled' : '';
  pagination.append(`<li class="page-item ${nextDisabled}"><a class="page-link" href="#" id="nextPage">ä¸‹ä¸€é </a></li>`);
}


  // æœå°‹æ™‚çš„åˆ†é 
  function renderCustomPagination(data, currentPage) {
    const totalPages = Math.ceil(data.length / pageSize);
    const pagination = $('#pagination');
    pagination.empty();

    if (totalPages <= 1) {
      pagination.hide();
      return;
    }
    pagination.show();

    const prevDisabled = (currentPage === 1) ? 'disabled' : '';
    pagination.append(`<li class="page-item ${prevDisabled}"><a class="page-link" href="#" id="prevPage">ä¸Šä¸€é </a></li>`);

    for (let i = 1; i <= totalPages; i++) {
      const activeClass = (i === currentPage) ? 'active' : '';
      pagination.append(`<li class="page-item ${activeClass}"><a class="page-link" href="#" data-custom-page="${i}">${i}</a></li>`);
    }

    const nextDisabled = (currentPage === totalPages) ? 'disabled' : '';
    pagination.append(`<li class="page-item ${nextDisabled}"><a class="page-link" href="#" id="nextPage">ä¸‹ä¸€é </a></li>`);

    pagination.off('click', 'a.page-link[data-custom-page]').on('click', 'a.page-link[data-custom-page]', function (e) {
      e.preventDefault();
      const newPage = parseInt($(this).data('custom-page'));
      renderPageData(data, newPage);
    });

    pagination.off('click', '#prevPage').on('click', '#prevPage', function (e) {
      e.preventDefault();
      if (currentPage > 1) renderPageData(data, currentPage - 1);
    });

    pagination.off('click', '#nextPage').on('click', '#nextPage', function (e) {
      e.preventDefault();
      if (currentPage < totalPages) renderPageData(data, currentPage + 1);
    });
  }

  // æ­£å¸¸æ¨¡å¼æ¸²æŸ“é¤å»³
  function renderPage(page) {
    const list = $('#restaurantList');
    list.empty();

    if (allRestaurants.length === 0) {
      list.append('<li class="list-group-item text-danger">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é¤å»³è³‡æ–™ã€‚</li>');
      $('#pagination').hide();
      return;
    }

    const start = (page - 1) * pageSize;
    const end = start + pageSize;
    const pageData = allRestaurants.slice(start, end);

    pageData.forEach(r => {
      const html = `
        <li class="list-group-item">
          <h5 class="mb-1"><a href="${r.url}" target="_blank">${r.name}</a></h5>
          <p class="mb-0 text-muted">ğŸ“ åœ°å€ï¼š${r.address}ï¼Œ${r.city}</p>
          <p class="mb-0">ğŸ’° åƒ¹ä½ï¼š${r.price_level}</p>
          <p class="mb-0">ğŸ½ï¸ èœç³»ï¼š${r.cuisine}</p>
          <p class="mb-0">ğŸ“ é›»è©±ï¼š${r.phone}</p>
          <p class="mb-0">ğŸ“ æè¿°ï¼š${r.description}</p>
        </li>`;
      list.append(html);
    });

    renderPagination();
  }

  // æœå°‹æ¸²æŸ“ï¼ˆä¸å½±éŸ¿æŒ‰éˆ•ç‹€æ…‹ï¼‰
  function renderPageData(data, page) {
    const list = $('#restaurantList');
    list.empty();

    if (data.length === 0) {
      list.append('<li class="list-group-item text-danger">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é¤å»³è³‡æ–™ã€‚</li>');
      $('#pagination').hide();
      return;
    }

    const totalPages = Math.ceil(data.length / pageSize);
    const start = (page - 1) * pageSize;
    const end = start + pageSize;
    const pageData = data.slice(start, end);

    pageData.forEach(r => {
      const html = `
        <li class="list-group-item">
          <h5 class="mb-1"><a href="${r.url}" target="_blank">${r.name}</a></h5>
          <p class="mb-0 text-muted">ğŸ“ åœ°å€ï¼š${r.address}ï¼Œ${r.city}</p>
          <p class="mb-0">ğŸ’° åƒ¹ä½ï¼š${r.price_level}</p>
          <p class="mb-0">ğŸ½ï¸ èœç³»ï¼š${r.cuisine}</p>
          <p class="mb-0">ğŸ“ é›»è©±ï¼š${r.phone}</p>
          <p class="mb-0">ğŸ“ æè¿°ï¼š${r.description}</p>
        </li>`;
      list.append(html);
    });

    renderCustomPagination(data, page);
  }

  // è¼‰å…¥é¤å»³ï¼ˆä¾åŸå¸‚ï¼‹èœç³»ï¼‰
  function loadRestaurants() {
    const cityParam = selectedCities.includes('all') ? '' : selectedCities.join(',');
    const cuisineParam = selectedCuisines.includes('all') ? '' : selectedCuisines.join(',');

    $.ajax({
      url: "{% url 'app_restaurants:api_get_restaurants' %}",
      data: { city: cityParam, cuisine: cuisineParam },
      success: function (response) {
        allRestaurants = response.restaurants;
        currentPage = 1;
        renderPage(currentPage);
      }
    });
  }

  // è¼‰å…¥åœ–è¡¨ï¼ˆä¾åŸå¸‚ï¼‰
  function loadChart() {
    const cityParam = selectedCities.includes('all') ? '' : selectedCities.join(',');

    $.ajax({
      url: "{% url 'app_restaurants:api_get_cuisine_stats' %}",
      data: { city: cityParam },
      success: function (response) {
        updateChart(response.cuisineStats);
      }
    });
  }

  // åœ–è¡¨æ›´æ–°
  function updateChart(data) {
    const labels = data.map(d => d.cuisine);
    const counts = data.map(d => d.count);

    if (chart) {
      chart.data.labels = labels;
      chart.data.datasets[0].data = counts;
      chart.update();
    } else {
      const ctx = document.getElementById('cuisineChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'é¤å»³æ•¸é‡',
            data: counts,
            backgroundColor: 'rgba(236, 192, 96, 0.7)',
            borderColor: 'rgba(236, 192, 96, 1)',
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              precision: 0,
              ticks: { stepSize: 1 }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.parsed.y} å®¶é¤å»³`;
                }
              }
            }
          }
        }
      });
    }
  }

  // åˆ†é æŒ‰éˆ•ï¼ˆæ­£å¸¸ï¼‰
  $('#pagination').on('click', 'a.page-link:not([data-custom-page])', function (e) {
    e.preventDefault();
    const text = $(this).text();
    const totalPages = Math.ceil(allRestaurants.length / pageSize);

    if (isSearching) return;

    if (text === 'ä¸Šä¸€é ' && currentPage > 1) currentPage--;
    else if (text === 'ä¸‹ä¸€é ' && currentPage < totalPages) currentPage++;
    else if (!isNaN(parseInt(text))) currentPage = parseInt(text);

    renderPage(currentPage);
    $('html, body').animate({ scrollTop: $('#restaurantList').offset().top - 70 }, 400);
  });

  // åŸå¸‚æŒ‰éˆ•é»æ“Š
  $('#cityButtons').on('click', 'button', function () {
    const city = $(this).data('city');

    if (city === 'all') {
      $('#cityButtons button').removeClass('btn-primary active').addClass('btn-outline-primary');
      $(this).removeClass('btn-outline-primary').addClass('btn-primary active');
      selectedCities = ['all'];
    } else {
      $(this).toggleClass('btn-outline-primary btn-primary active');
      $('#cityButtons button[data-city="all"]').removeClass('btn-primary active').addClass('btn-outline-primary');
      selectedCities = $('#cityButtons button.btn-primary.active').map(function () {
        return $(this).data('city');
      }).get();
      if (selectedCities.length === 0) {
        $('#cityButtons button[data-city="all"]').removeClass('btn-outline-primary').addClass('btn-primary active');
        selectedCities = ['all'];
      }
    }

    loadRestaurants();
    loadChart();
  });

  // èœç³»æŒ‰éˆ•ï¼ˆå–®é¸ï¼‰
  $('#cuisineButtons').on('click', 'button', function () {
    const cuisine = $(this).data('cuisine');

    $('#cuisineButtons button').removeClass('btn-primary active').addClass('btn-outline-info');
    if (cuisine === 'all') {
      $(this).removeClass('btn-outline-info').addClass('btn-primary active');
      selectedCuisines = ['all'];
    } else {
      $(this).removeClass('btn-outline-info').addClass('btn-primary active');
      selectedCuisines = [cuisine];
    }

    $('#cuisineSearch').val('');
    isSearching = false;
    loadRestaurants();
  });

  // æœå°‹è¼¸å…¥äº‹ä»¶ï¼ˆåªæ›´æ–°æ¸…å–®ï¼Œä¸å‹•æŒ‰éˆ•ï¼‰
  $('#cuisineSearch').on('input', function () {
    const keyword = $(this).val().toLowerCase().trim();
    if (!keyword) {
      isSearching = false;
      renderPage(1);
      return;
    }

    isSearching = true;
    const filtered = allRestaurants.filter(r => {
      return r.cuisine.toLowerCase().includes(keyword);
    });

    renderPageData(filtered, 1);
  });

  // åˆå§‹è¼‰å…¥
  loadRestaurants();
  loadChart();
});
</script>
{% endblock %}
